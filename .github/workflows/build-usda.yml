name: Build USDA Database

on:
  workflow_dispatch:
    inputs:
      usda_zip_url:
        description: "Direct URL to USDA CSV zip (required - get from https://fdc.nal.usda.gov/download-datasets)"
        required: true
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1
      
      - name: Install dependencies
        run: bun install
      
      - name: Download USDA CSV
        run: |
          mkdir -p data/usda
          
          if [ -z "${{ inputs.usda_zip_url }}" ]; then
            echo "::error::USDA ZIP URL is required. Download from https://fdc.nal.usda.gov/download-datasets and provide the direct download URL."
            exit 1
          fi
          
          echo "Downloading from: ${{ inputs.usda_zip_url }}"
          curl -fL --progress-bar -o data/usda/FoodData_Central_csv_2025-12-18.zip "${{ inputs.usda_zip_url }}"
          
          ls -lh data/usda/
          file data/usda/FoodData_Central_csv_2025-12-18.zip
          
          # Verify it's a valid zip
          if ! unzip -t data/usda/FoodData_Central_csv_2025-12-18.zip >/dev/null 2>&1; then
            echo "::error::Invalid or corrupted ZIP file."
            exit 1
          fi
          echo "ZIP file validated successfully"
      
      - name: Import USDA data
        env:
          NOMNOM_DATA_DIR: ${{ github.workspace }}/data
        run: bun run import:usda
      
      - name: Compress database
        run: |
          gzip -9 -k data/usda/usda_fdc.sqlite
          ls -lh data/usda/
          echo "Database size: $(du -h data/usda/usda_fdc.sqlite.gz | cut -f1)"
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: usda
          name: USDA FoodData Central Database
          files: data/usda/usda_fdc.sqlite.gz
          body: |
            USDA FoodData Central SQLite database with FTS5 search.
            
            - Foods: 2M+ entries  
            - Full-text search enabled
            - Compatible with NomNom Numbers CLI
            
            To use:
            ```bash
            bun start init --download-usda
            # or it auto-downloads on first search/lookup
            bun start search "chicken"
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
